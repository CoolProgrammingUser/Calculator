<!doctype html>
<html class="html-class">
	<head>
		<title>
			Calculator
		</title>
		<script src="https://epicenterprograms.github.io/standards/behavior/general.js"></script>
		<script>
			var S = Standards.general;
			var intervals = {};
			var keys = {};
			var position = {left:0, top:0};
			var previousEvaluation = "";
			window.addEventListener("load", function() {  // This is what runs when the page loads; equivalent to <body onload=aFunction()>
				intervals.checker = setInterval(keyResponse, 10);
			});
			document.addEventListener("keydown", function(event) {  // This is when a key is pressed down. This is continually called.
				if (document.activeElement != document.getElementById("expression")) {  // allows navigating the expression input (and do it without moving stuff)
					if ([37, 38, 39, 40].some(function (code) { return event.keyCode == code; })) {  // if an arrow key was pressed
						event.preventDefault();
					}
					keys[String(event.keyCode)] = true;
				} else if (event.keyCode == 13) {  // if the "Enter" key is pressed
					solve();
				}
			});
			document.addEventListener("keyup", function(event) {  // This is when a key is let up.
				keys[String(event.keyCode)] = false;
			});
			function keyResponse() {
				S.forEach(keys, function (trueFalse, key) {
					if (trueFalse == true) {
						switch (Number(key)) {
							case 37:  // left arrow key is pressed
								position.left--;
								break;
							case 38:  // up arrow key is pressed
								position.top--;
								break;
							case 39:  // right arrow key is pressed
								position.left++;
								break;
							case 40:  // down arrow key is pressed
								position.top++;
								break;
						}
					}
				});
				document.getElementById("dot").style.left = position.left / 10.0 + "em";
				document.getElementById("dot").style.top = position.top / 10.0 + "em";
			}
			document.addEventListener("mouseup", function(){
				document.getElementById("inputOutput").style.background = hexSet([255*Math.round(Math.random()), 255*Math.round(Math.random()), 255*Math.round(Math.random())], 2, '#');
			});
			var Entity = function(specs) {
				specs = specs || {};
				this.appearance = {"background-color": String(hexSet([255*Math.round(Math.random()), 255*Math.round(Math.random()), 255*Math.round(Math.random())], 2, '#'))};
				this.position = {"top": String((document.body.clientHeight-40)*Math.random()) + "px"};
				S.forEach(specs, function(value, specification) {
					switch(specification) {
						case "appearance":
							S.forEach(value, function(feature, key) {
								this.appearance[key] = feature;
							});
							break;
						case "position":
							S.forEach(value, function(place, key) {
								this.position[key] = place;
							});
							break;
					}
				});
				let div = document.createElement("div");
				div.className = "phrase-bullet";
				document.body.appendChild(div);  // Actually makes the div appear.
				S.forEach(this.appearance, function (style, attribute) {
					div.style[attribute] = style;
				});
				S.forEach(this.position, function (style, attribute) {
					div.style[attribute] = style;
				});
				let messages = ["Wahoo!", "Yipee!", "Numbers rule!", "Show math who's boss!", "You + Calculator =<br>AWESOMENESS!", "3 + 3 = 3!"];
				div.innerHTML = messages[Math.floor(Math.random()*messages.length)];
				setTimeout(function() {
					div.style.left = "-25em";  // This doesn't happen immediately because of the transition.
				}, 0);
				setTimeout(function() {
					document.body.removeChild(div);
				}, 5000);  // This is the duration of the transition.
				div.addEventListener("click", function() {
					if (document.getElementById("scoreBox").offsetParent === null) {  // checks whether #scoreBox is displayed
						document.getElementById("scoreBox").style.display = "inline-block";
						document.getElementById("score").innerHTML = "Score: 1";
					} else {
						let text = document.getElementById("score").innerHTML;
						document.getElementById("score").innerHTML = "Score: " + (Number(text.split(" ")[1])+1);
					}
				});
			}
			function solve() {
				let expression = document.getElementById("expression").value.trim().toLowerCase();
				if (expression.search(/^(?:(?:the )?answer to )?life,? the universe,? (?:and|&) everything$/) == -1) {
					// gets rid of anything that isn't math
					expression = expression.replace(/arccosine|arcsine|arctangent|cosine|sine|tangent|arccos|arcsin|arctan|acos|asin|atan|cos|sin|tan|pi|e|[^\d.()+*^%/=<>-]/g, function (match) {
						switch (match) {
							case "arccosine":
							case "arcsine":
							case "arctangent":
							case "cosine":
							case "sine":
							case "tangent":
							case "arccos":
							case "arcsin":
							case "arctan":
							case "acos":
							case "asin":
							case "atan":
							case "cos":
							case "sin":
							case "tan":
							case "pi":
							case "e":
								return match;
							default:
								return "";
						}
					});
				} else {
					expression = "42";
				}
				if (expression != document.getElementById("expression").value.trim() && expression != "42") {
					alert("Invalid characters were used in the mathematical expression.");
				} else if (expression == "") {
					return;
				} else {
					expression = expression.replace(/==+/g, "=");
					expression = expression.replace(/([^<>])=(?!<|>)/g, function (match) { return match + "="; });
					expression = expression.replace(/=<|==</g, "<=");
					expression = expression.replace(/=>|==>/g, ">=");
					expression = expression.replace(/(\([^)]+\)|\w+\.?\d*|\.\d+)\^(\([^)]+\)|-?\w+\.?\d*|-?\.\d+)/g, function (match, base, exponent) {  // replaces mathematical exponent syntax with JavaScript exponent syntax
						return "Math.pow(" + base + ", " + exponent + ")";
					});
					expression = expression.replace(/(^|[^a-z])(?:arccosine|arccos|acos)\(([^)]+)\)/g, function (match, char, acos) {return char+"Math.acos("+acos+")";});
					expression = expression.replace(/(^|[^a-z])(?:arcsine|arcsin|asin)\(([^)]+)\)/g, function (match, char, asin) {return char+"Math.asin("+asin+")";});
					expression = expression.replace(/(^|[^a-z])(?:arctangent|arctan|atan)\(([^)]+)\)/g, function (match, char, atan) {return char+"Math.atan("+atan+")";});
					expression = expression.replace(/(^|[^a-z])(?:cosine|cos)\(([^)]+)\)/g, function (match, char, cos) { return char + "Math.cos(" + cos + ")"; });
					expression = expression.replace(/(^|[^a-z])(?:sine|sin)\(([^)]+)\)/g, function (match, char, sin) { return char + "Math.sin(" + sin + ")"; });
					expression = expression.replace(/(^|[^a-z])(?:tangent|tan)\(([^)]+)\)/g, function (match, char, tan) { return char + "Math.tan(" + tan + ")"; });
					expression = expression.replace(/(^|[^a-z])pi(?![a-z])/g, function (match, char) { return char + "Math.PI"; });
					expression = expression.replace(/(^|[^a-z])e(?![a-z])/g, function (match, char) { return char + "Math.E"; });
					try {
						let answer = String(eval(expression));
						if (answer.includes("e")) {  // if the answer is in scientific notation
							if (answer != String(Math.round(Number(answer.split("e")[0]) * 1000000) / 1000000)) {  // if the significand goes to more than 6 decimal places
								document.getElementById("box3").value = Math.round(Number(answer.split("e")[0]) * 1000000) / 1000000;
							} else {
								document.getElementById("box3").value = answer.split("e")[0];
							}
							document.getElementById("exponent").textContent = answer.split("e")[1];
							document.getElementById("tenToAPower").style.display = "inline-block";
						} else {
							document.getElementById("box3").value = answer;
							document.getElementById("tenToAPower").style.display = "none";
						}
						if (answer === true) {
							document.getElementById("box3").style.color = "#0a0";
						} else if (answer === false) {
							document.getElementById("box3").style.color = "red";
						} else {
							document.getElementById("box3").style.color = "black";
						}
						makeEntity();
					} catch (error) {
						console.error(error);
						alert("There was a problem interpreting your expression.");
					}
				}
			}
			function clearValue() {  // This can't be called "clear()".
				document.getElementById("expression").value = "";
				document.getElementById("box3").value = "";
				document.getElementById("tenToAPower").style.display = "none";
				keys["39"] = true;
				setTimeout(function() {
					keys["39"] = false;
					keys["40"] = true;
					setTimeout(function() {
						keys["40"] = false;
						keys["37"] = true;
						setTimeout(function() {
							keys["37"] = false;
							keys["38"] = true;
							setTimeout(function() {
								keys["38"] = false;
								keys["39"] = true;
								setTimeout(function() {
									keys["39"] = false;
									position.left = 0;
									position.top = 0;
								}, 1000);
							}, 1100);
						}, 2000);
					}, 1100);
				}, 1000);
				makeEntity();
			}
			function transfer() {
				S.getId("expression").value = S.getId("box3").value;
				makeEntity();
			}
			function makeEntity() {
				if (previousEvaluation != S.getId("expression").value.trim()) {
					new Entity();
					previousEvaluation = S.getId("expression").value.trim();
				}
			}
			function hexSet(numberList, digits, prefix) {
				var result = "";
				S.forEach(numberList, function(number) {
					number = Math.round(number);
					number = number.toString(16);
					while (number.length < digits) {
						number = "0" + number;
					}
					result += number;
				});
				return (prefix || "") + result;
			}
		</script>
		<link rel="stylesheet" href="https://epicenterprograms.github.io/standards/formatting/foundation.css">
		<style>
			body {
				min-height: auto;
				padding: 0em;
				background: linear-gradient(to bottom right, red, orange, yellow, green, blue, purple);
			}
			button {
				margin: 0em;
			}
			.morph {
				border: .05em solid #aaaaaa;
			}
			.morph input {
				padding: .15em;
			}
			.morph:hover {
				border-radius: 1em;
			}
			.phrase-bullet {
				position: absolute;
				left: 100vw;
				border-radius: 1em 0em 0em 1em;
				padding: .5em;
				color: white;
				font-size: 2em;
				text-shadow: 0em 0em .1em black, 0em 0em .1em black;
				white-space: nowrap;
				cursor: pointer;
				-webkit-transition: left 5s linear;
				-ms-transition: left 5s linear;
				transition: left 5s linear;
			}
			#title {
				color: black;
				text-decoration: none;
			}
			#title:hover {
				color: blue;
				text-decoration: underline;
			}
			#inputOutput {
				position: relative;
				border: .1em solid black;
				background: blue;
				width: 15em;
				height: 15em;
			}
			#expression {
				margin: 1em auto;
				width: 15em;
			}
			#answer {
				position: absolute;
				left: 4.25em;
				bottom: 1em;
				margin: auto;
				background: white;
			}
			#answer input:first-child {
				width: 8em;
			}
			#tenToAPower {
				display: none;
			}
			#dot {
				position: relative;
				padding: 1em;
				background: blue;
				border-radius: 1em;
				margin: 1.7em auto 0em;
			}
			#scoreBox {
				display: none;
				padding: 1.5em;
				background: radial-gradient(ellipse, white, transparent, transparent);
				-webkit-animation: pulse 1s ease infinite 0s alternate;
				animation: pulse 1s ease infinite 0s alternate;
			}
			@keyframes pulse {
				from {
					margin: 2em;
					padding: 1.5em;
				}
				to {
					margin: 0em;
					padding: 3.5em;
				}
			}
		</style>
	</head>
	<body>
		<h1>
			<a href="https://epicenterprograms.github.io/calculator/turnedInVersion" title="Click for awesomeness" id="title">
				Calculator
			</a>
		</h1>
		<div id="inputOutput">
			<input type="text" class="morph" id="expression" placeholder="Type your expression">
			<div id="answer">
				<input type="text" id="box3" readonly="true" placeholder="Result">
				<div id="tenToAPower">
					&times; 10<sup id="exponent">0</sup>
				</div>
			</div>
			<br>
			<div id="dot">
				<button class="morph" onclick="solve()">
					=
				</button>
				<br>
				<button class="morph" onclick="transfer()">
					Ans
				</button>
				<br>
				<button class="morph" onclick="clearValue()">
					Clear
				</button>
			</div>
		</div>
		<br>
		<div id="scoreBox">
			<p id="score"></p>
		</div>
	</body>
</html>
